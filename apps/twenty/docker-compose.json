{
    "$schema": "../dynamic-compose-schema.json",
    "services": [
        {
            "name": "twenty",
            "image": "twentycrm/twenty:latest",
            "internalPort": 3000,
            "isMain": true,
            "volumes": [
                {
                    "hostPath": "${APP_DATA_DIR}/server-local-data",
                    "containerPath": "/app/packages/twenty-server/.local-storage"
                }
            ],
            "environment": {
                "NODE_PORT": "3000",
                "PG_DATABASE_URL": "postgres://${PG_DATABASE_USER:-postgres}:${PG_DATABASE_PASSWORD:-postgres}@${PG_DATABASE_HOST:-db}:${PG_DATABASE_PORT:-5432}/default",
                "SERVER_URL": "https://${APP_DOMAIN}",
                "REDIS_URL": "redis://redis:6379",
                "APP_SECRET": "${APP_SECRET}"
            },
            "healthCheck": {
                "test": "curl --fail http://localhost:3000/healthz",
                "interval": "5s",
                "timeout": "5s",
                "retries": 20
            }
        },
        {
            "name": "worker",
            "image": "twentycrm/twenty:latest",
            "volumes": [
                {
                    "hostPath": "${APP_DATA_DIR}/server-local-data",
                    "containerPath": "/app/packages/twenty-server/.local-storage"
                }
            ],
            "command": ["yarn", "worker:prod"],
            "environment": {
                "PG_DATABASE_URL": "postgres://${PG_DATABASE_USER:-postgres}:${PG_DATABASE_PASSWORD:-postgres}@${PG_DATABASE_HOST:-db}:${PG_DATABASE_PORT:-5432}/default",
                "SERVER_URL": "https://${APP_DOMAIN}",
                "REDIS_URL": "redis://redis:6379",
                "DISABLE_DB_MIGRATIONS": "true",
                "DISABLE_CRON_JOBS_REGISTRATION": "true",
                "APP_SECRET": "${APP_SECRET}"
            }
        },
        {
            "name": "db",
            "image": "postgres:16",
            "volumes": [
                {
                    "hostPath": "${APP_DATA_DIR}/db-data",
                    "containerPath": "/var/lib/postgresql/data"
                }
            ],
            "environment": {
                "POSTGRES_USER": "${PG_DATABASE_USER:-postgres}",
                "POSTGRES_PASSWORD": "${PG_DATABASE_PASSWORD:-postgres}"
            },
            "healthCheck": {
                "test": "pg_isready -U ${PG_DATABASE_USER:-postgres} -h localhost -d postgres",
                "interval": "5s",
                "timeout": "5s",
                "retries": 10
            }
        },
        {
            "name": "redis",
            "image": "redis",
            "command": ["--maxmemory-policy", "noeviction"]
        }
    ]
}
