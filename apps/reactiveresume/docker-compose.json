{
  "services": [
    {
      "name": "postgres",
      "image": "postgres:16-alpine",
      "environment": {
        "POSTGRES_DB": "postgres",
        "POSTGRES_USER": "postgres",
        "POSTGRES_PASSWORD": "postgres"
      },
      "volumes": [
        {
          "hostPath": "${APP_DATA_DIR}/postgres",
          "containerPath": "/var/lib/postgresql/data",
          "readOnly": false,
          "shared": false,
          "private": false
        }
      ],
      "healthCheck": {
        "test": "pg_isready -U postgres -d postgres",
        "interval": "10s",
        "timeout": "5s",
        "retries": 5
      }
    },
    {
      "name": "minio",
      "image": "minio/minio:latest",
      "command": "server /data",
      "environment": {
        "PORT": 9000,
        "MINIO_ROOT_USER": "${MINIO_ROOT_USER}",
        "MINIO_ROOT_PASSWORD": "${MINIO_ROOT_PASSWORD}"
      },
      "internalPort": 9000,
      "volumes": [
        {
          "hostPath": "${APP_DATA_DIR}/minio",
          "containerPath": "/data",
          "readOnly": false,
          "shared": false,
          "private": false
        }
      ],
      "healthCheck": {
        "test": "curl --fail http://localhost:9000/minio/health/live || exit 1",
        "interval": "10s",
        "timeout": "5s",
        "retries": 5,
        "start_period": "20s"
      }
    },
    {
      "name": "chrome",
      "image": "ghcr.io/browserless/chromium:v2.18.0",
      "environment": {
        "TIMEOUT": 10000,
        "CONCURRENT": 10,
        "TOKEN": "chrome_token",
        "EXIT_ON_HEALTH_FAILURE": "true",
        "PRE_REQUEST_HEALTH_CHECK": "true"
      },
      "extraHosts": [
        "host.docker.internal:host-gateway"
      ]
    },
    {
      "name": "app",
      "image": "amruthpillai/reactive-resume:latest",
      "environment": {
        "PORT": 3000,
        "NODE_ENV": "production",
        "PUBLIC_URL": "${APP_PROTOCOL}://${APP_DOMAIN}",
        "STORAGE_URL": "${APP_PROTOCOL}://${APP_DOMAIN}/default",
        "CHROME_TOKEN": "chrome_token",
        "CHROME_URL": "ws://chrome:3000",
        "DATABASE_URL": "postgresql://postgres:postgres@postgres:5432/postgres",
        "ACCESS_TOKEN_SECRET": "${ACCESS_TOKEN_SECRET}",
        "REFRESH_TOKEN_SECRET": "${REFRESH_TOKEN_SECRET}",
        "MAIL_FROM": "${MAIL_FROM}",
        "STORAGE_ENDPOINT": "minio",
        "STORAGE_PORT": 9000,
        "STORAGE_REGION": "us-east-1",
        "STORAGE_BUCKET": "default",
        "STORAGE_ACCESS_KEY": "${MINIO_ROOT_USER}",
        "STORAGE_SECRET_KEY": "${MINIO_ROOT_PASSWORD}",
        "STORAGE_USE_SSL": "false",
        "STORAGE_SKIP_BUCKET_CHECK": "false"
      },
      "internalPort": 3000,
      "dependsOn": {
        "postgres": {
          "condition": "service_healthy"
        },
        "minio": {
          "condition": "service_healthy"
        },
        "chrome": {
          "condition": "service_started"
        }
      },
      "isMain": true
    }
  ],
  "extraLabels": {
    "traefik.http.services.{{RUNTIPI_APP_ID}}-minio.loadbalancer.server.port": "9000",
    "traefik.http.services.{{RUNTIPI_APP_ID}}-minio.loadbalancer.server.scheme": "http",
    "traefik.http.routers.{{RUNTIPI_APP_ID}}-minio.rule": "Host(`${APP_DOMAIN}`) && (Path(`/default`) || PathPrefix(`/default/`))",
    "traefik.http.routers.{{RUNTIPI_APP_ID}}-minio.service": "{{RUNTIPI_APP_ID}}-minio",
    "traefik.http.routers.{{RUNTIPI_APP_ID}}-minio.entrypoints": "websecure",
    "traefik.http.routers.{{RUNTIPI_APP_ID}}-minio.tls.certresolver": "myresolver",
    "traefik.http.routers.{{RUNTIPI_APP_ID}}-minio.priority": "10000",

    "traefik.http.services.{{RUNTIPI_APP_ID}}.loadbalancer.server.port": "3000",
    "traefik.http.routers.{{RUNTIPI_APP_ID}}.rule": "Host(`${APP_DOMAIN}`) && !PathPrefix(`/default`)",
    "traefik.http.routers.{{RUNTIPI_APP_ID}}.entrypoints": "websecure",
    "traefik.http.routers.{{RUNTIPI_APP_ID}}.tls.certresolver": "myresolver",

    "traefik.http.routers.{{RUNTIPI_APP_ID}}-minio-insecure.rule": "Host(`${APP_DOMAIN}`) && (Path(`/default`) || PathPrefix(`/default/`))",
    "traefik.http.routers.{{RUNTIPI_APP_ID}}-minio-insecure.service": "{{RUNTIPI_APP_ID}}-minio",
    "traefik.http.routers.{{RUNTIPI_APP_ID}}-minio-insecure.entrypoints": "web",
    "traefik.http.routers.{{RUNTIPI_APP_ID}}-minio-insecure.middlewares": "{{RUNTIPI_APP_ID}}-minio-redirect",
    "traefik.http.middlewares.{{RUNTIPI_APP_ID}}-minio-redirect.redirectscheme.scheme": "https"
  }
}
