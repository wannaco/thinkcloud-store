{
  "services": [
    {
      "name": "postgres",
      "image": "postgres:16-alpine",
      "environment": {
        "POSTGRES_DB": "postgres",
        "POSTGRES_USER": "postgres",
        "POSTGRES_PASSWORD": "postgres"
      },
      "volumes": [
        {
          "hostPath": "${APP_DATA_DIR}/postgres",
          "containerPath": "/var/lib/postgresql/data",
          "readOnly": false,
          "shared": false,
          "private": false
        }
      ],
      "healthCheck": {
        "test": "pg_isready -U postgres -d postgres",
        "interval": "10s",
        "timeout": "5s",
        "retries": 5
      }
    },
    {
      "name": "minio",
      "image": "minio/minio:latest",
      "command": "server /data",
      "environment": {
        "PORT": 9000,
        "MINIO_ROOT_USER": "${MINIO_ROOT_USER}",
        "MINIO_ROOT_PASSWORD": "${MINIO_ROOT_PASSWORD}",
        "MINIO_SERVER_URL": "${APP_PROTOCOL}://${APP_DOMAIN}/default"
      },
      "internalPort": 9000,
      "addToMainNetwork": true,
      "volumes": [
        {
          "hostPath": "${APP_DATA_DIR}/minio",
          "containerPath": "/data",
          "readOnly": false,
          "shared": false,
          "private": false
        }
      ],
      "healthCheck": {
        "test": "curl --fail http://localhost:9000/minio/health/live || exit 1",
        "interval": "10s",
        "timeout": "5s",
        "retries": 5,
        "start_period": "20s"
      }
    },
    {
      "name": "chrome",
      "image": "ghcr.io/browserless/chromium:v2.18.0",
      "environment": {
        "TIMEOUT": 10000,
        "CONCURRENT": 10,
        "TOKEN": "chrome_token",
        "EXIT_ON_HEALTH_FAILURE": "true",
        "PRE_REQUEST_HEALTH_CHECK": "true"
      },
      "extraHosts": [
        "host.docker.internal:host-gateway"
      ]
    },
    {
      "name": "app",
      "image": "amruthpillai/reactive-resume:latest",
      "environment": {
        "PORT": 3000,
        "NODE_ENV": "production",
        "PUBLIC_URL": "${APP_PROTOCOL}://${APP_DOMAIN}",
        "STORAGE_URL": "${APP_PROTOCOL}://${APP_DOMAIN}/default",
        "CHROME_TOKEN": "chrome_token",
        "CHROME_URL": "ws://chrome:3000",
        "DATABASE_URL": "postgresql://postgres:postgres@postgres:5432/postgres",
        "ACCESS_TOKEN_SECRET": "${ACCESS_TOKEN_SECRET}",
        "REFRESH_TOKEN_SECRET": "${REFRESH_TOKEN_SECRET}",
        "MAIL_FROM": "${MAIL_FROM}",
        "STORAGE_ENDPOINT": "minio",
        "STORAGE_PORT": 9000,
        "STORAGE_REGION": "us-east-1",
        "STORAGE_BUCKET": "default",
        "STORAGE_ACCESS_KEY": "${MINIO_ROOT_USER}",
        "STORAGE_SECRET_KEY": "${MINIO_ROOT_PASSWORD}",
        "STORAGE_USE_SSL": "false",
        "STORAGE_FORCE_PATH_STYLE": "true",
        "STORAGE_SKIP_BUCKET_CHECK": "false"
      },
      "internalPort": 3000,
      "dependsOn": {
        "postgres": {
          "condition": "service_healthy"
        },
        "minio": {
          "condition": "service_healthy"
        },
        "chrome": {
          "condition": "service_started"
        }
      },
      "isMain": false
    },
    {
      "name": "proxy",
      "image": "nginx:alpine",
      "internalPort": 80,
      "isMain": true,
      "dependsOn": {
        "app": { "condition": "service_started" },
        "minio": { "condition": "service_started" }
      },
      "command": [
        "sh",
        "-c",
        "cat > /etc/nginx/conf.d/default.conf <<'EOF'\\nserver {\\n  listen 80;\\n  server_name _ ;\\n\\n  # MinIO health and console paths\\n  location /minio/ {\\n    proxy_set_header Host \\\\\\\\$host;\\n    proxy_pass http://minio:9000/minio/;\\n  }\\n\\n  # MinIO bucket path prefix\\n  location /default/ {\\n    proxy_set_header Host \\\\\\\\$host;\\n    proxy_pass http://minio:9000/default/;\\n  }\\n\\n  # Everything else to Reactive Resume app\\n  location / {\\n    proxy_set_header Host \\\\\\\\$host;\\n    proxy_set_header X-Forwarded-For \\\\\\\\\\\\\\\\$proxy_add_x_forwarded_for;\\n    proxy_set_header X-Forwarded-Proto \\\\\\\\\\\\\\\\$scheme;\\n    proxy_pass http://app:3000/;\\n  }\\n}\\n'EOF'\\n\\nnginx -g 'daemon off;'"
      ]
    }
  ],
  "extraLabels": {
    "traefik.enable": "true",
    "traefik.http.services.{{RUNTIPI_APP_ID}}.loadbalancer.server.port": "80",
    "traefik.http.routers.{{RUNTIPI_APP_ID}}.rule":  "Host(`{{APP_DOMAIN}}`)",
    "traefik.http.routers.{{RUNTIPI_APP_ID}}.entrypoints": "websecure",
    "traefik.http.routers.{{RUNTIPI_APP_ID}}.tls.certresolver": "myresolver"
  }
}
